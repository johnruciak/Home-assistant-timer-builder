# Technical Documentation: EntityTimer

## 1. Overview
EntityTimer is a specialized YAML generator for Home Assistant. It bridges the gap between simple device control and complex, safe automation logic. While it features a "Visual Discovery" mode for quick prototyping, its core architecture is designed for **JSON Data-Driven Discovery**, ensuring production-ready accuracy by using your system's actual state data.

## 2. Discovery Engines

### A. JSON Import (Primary / Precise)
The most reliable way to use EntityTimer is by providing your Home Assistant `states` data.
*   **Mechanism**: The app parses Home Assistant's internal state machine JSON.
*   **Data Source**: Users can copy JSON directly from **Developer Tools > States** or use tools like **Entity Exporter**.
*   **Benefit**: Eliminates entity ID typos and provides exact friendly names.

### B. Visual Discovery (Secondary / Experimental)
Uses the Gemini 3 Pro Vision model to "read" screenshots.
*   **Protocol**: It identifies UI components (cards, sliders, toggles) and maps them to standard Home Assistant domains.
*   **Use Case**: Rapidly generating timers for devices visible on a dashboard without hunting for their technical IDs manually.

## 3. Mandatory Home Assistant Setup
Home Assistant requires explicit configuration to handle modular package files.

### Step A: Enable Packages
Add this to your `configuration.yaml`:

```yaml
homeassistant:
  packages: !include_dir_named packages/
```

### Step B: The Packages Folder
1. Create a folder named `packages` in your `/config/` directory.
2. Every file generated by this tool should be placed inside this folder.
3. **Important**: If you already have existing packages, ensure they don't use the same "slug" names as generated by this tool (e.g., `timer.garden_valve`).

## 4. Technical Architecture
EntityTimer generates **Atomic Packages**. Each package follows this blueprint:

1.  **Helper Entities**: `input_number` for duration and `input_datetime` (if scheduled).
2.  **Safety Watchdog**: A native `timer` entity that tracks remaining time across restarts.
3.  **Automation Logic**:
    *   **Trigger**: Device state changes to 'on'.
    *   **Action**: Start the timer with the duration from the helper.
    *   **Safety**: If the timer finishes, the device is explicitly called to 'off'.
4.  **UI Script**: A standardized script that users can add to their dashboard to trigger the manual override.

## 5. Development & Contribution

### Tech Stack
*   **Frontend**: React 19 + Tailwind CSS.
*   **AI Engine**: Google GenAI SDK (Gemini 3 Pro).
*   **State Management**: React `useReducer` for atomic state transitions.

### Key Files
*   `services/gemini.ts`: Contains the system instructions and logic for YAML generation.
*   `components/EntityLibrary.tsx`: Handles the JSON parsing and regex-based entity extraction.
*   `state/reducer.ts`: Manages the global application state.

## 6. Known Limitations & Safety
*   **Restart Behavior**: While `timer` entities survive restarts, the *active* countdown will pause unless configured otherwise. The generated code defaults to safe 'off' states.
*   **Domain Support**: Optimized for `switch`, `light`, `valve`, `fan`, and `climate`. Other domains may require manual YAML tweaks after generation.

---

**License**: MIT
Created for the Home Assistant Community.
